<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>start (Skynet::Manager)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File lib/skynet/skynet_manager.rb, line 394</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">options</span>={})
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:add_workers</span>]    <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">nil</span>
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:remove_workers</span>] <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">nil</span>
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:use_rails</span>]      <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">false</span>
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:required_libs</span>]  <span class="ruby-operator">||=</span> []
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:workers</span>]        <span class="ruby-operator">||=</span> <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:NUMBER_OF_WORKERS</span>] <span class="ruby-operator">||</span> <span class="ruby-value">4</span>
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:pid_file</span>]       <span class="ruby-operator">||=</span> <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:SKYNET_PIDS_FILE</span>]
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script_path</span>]    <span class="ruby-operator">||=</span> <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:LAUNCHER_PATH</span>]

      <span class="ruby-identifier">config</span> = <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">Config</span>.<span class="ruby-identifier">new</span>

      <span class="ruby-constant">OptionParser</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">opt</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">banner</span> = <span class="ruby-value str">%{Usage: 
        &gt; skynet [options]

        You can also run:
        &gt; skynet console [options]
        }</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">''</span>, <span class="ruby-value str">'--restart-all-workers'</span>, <span class="ruby-value str">'Restart All Workers'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Restarting ALL workers on ALL machines.&quot;</span>
          <span class="ruby-keyword kw">begin</span>
            <span class="ruby-identifier">manager</span> = <span class="ruby-constant">DRbObject</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:SKYNET_LOCAL_MANAGER_URL</span>])
            <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">restart_all_workers</span>
            <span class="ruby-identifier">exit</span>
          <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">DRb</span><span class="ruby-operator">::</span><span class="ruby-constant">DRbConnError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
            <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;No manager running at #{Skynet::CONFIG[:SKYNET_LOCAL_MANAGER_URL]}  ERROR: #{e.inspect}&quot;</span>
            <span class="ruby-identifier">exit</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">''</span>, <span class="ruby-value str">'--restart-workers'</span>, <span class="ruby-value str">'Restart Workers'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Restarting workers on this machine.&quot;</span>
          <span class="ruby-keyword kw">begin</span>
            <span class="ruby-identifier">manager</span> = <span class="ruby-constant">DRbObject</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:SKYNET_LOCAL_MANAGER_URL</span>])
            <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">restart_workers</span>
            <span class="ruby-identifier">exit</span>
          <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">DRb</span><span class="ruby-operator">::</span><span class="ruby-constant">DRbConnError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
            <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;No manager running at #{Skynet::CONFIG[:SKYNET_LOCAL_MANAGER_URL]}  ERROR: #{e.inspect}&quot;</span>
            <span class="ruby-identifier">exit</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-i'</span>, <span class="ruby-value str">'--increment-worker-version'</span>, <span class="ruby-value str">'Increment Worker Version'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">ver</span> = <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">MessageQueue</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">increment_worker_version</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Incrementing Worker Version to #{ver}&quot;</span>
          <span class="ruby-identifier">exit</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-a'</span>, <span class="ruby-value str">'--add-workers WORKERS'</span>, <span class="ruby-value str">'Number of workers to add.'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:add_workers</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-k'</span>, <span class="ruby-value str">'--remove-workers WORKERS'</span>, <span class="ruby-value str">'Number of workers to remove.'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:remove_workers</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-w'</span>, <span class="ruby-value str">'--workers WORKERS'</span>, <span class="ruby-value str">'Number of workers to start.'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:workers</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-keyword kw">end</span>               
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-r'</span>, <span class="ruby-value str">'--required LIBRARY'</span>, <span class="ruby-value str">'Require the specified libraries'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:required_libs</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">v</span>)
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-q'</span>, <span class="ruby-value str">'--queue QUEUE_NAME'</span>, <span class="ruby-value str">'Which queue should these workers use (default &quot;default&quot;).'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue</span>] = <span class="ruby-identifier">v</span>
        <span class="ruby-keyword kw">end</span>               
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value str">'-i'</span>, <span class="ruby-value str">'--queue_id queue_id'</span>, <span class="ruby-value str">'Which queue should these workers use (default 0).'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
          <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue_id</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-keyword kw">end</span>               
        <span class="ruby-identifier">opt</span>.<span class="ruby-identifier">parse!</span>(<span class="ruby-constant">ARGV</span>)
      <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue</span>]
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue_id</span>]
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;You may either provide a queue_id or a queue, but not both.&quot;</span>)
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue_id</span>] = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">queue_id_by_name</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue</span>])
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:queue_id</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>        
      <span class="ruby-keyword kw">end</span>
      
      <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:required_libs</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">adlib</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword kw">begin</span>
          <span class="ruby-identifier">require</span> <span class="ruby-identifier">adlib</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">MissingSourceFile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
          <span class="ruby-identifier">error</span> <span class="ruby-node">&quot;The included lib #{adlib} was not found: #{e.inspect}&quot;</span>
          <span class="ruby-identifier">exit</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>        

      <span class="ruby-comment cmt"># Handle add or remove workers</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:add_workers</span>] <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:remove_workers</span>]
        <span class="ruby-keyword kw">begin</span>
          <span class="ruby-identifier">manager</span> = <span class="ruby-constant">DRbObject</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:SKYNET_LOCAL_MANAGER_URL</span>])    
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:add_workers</span>]
            <span class="ruby-identifier">pids</span> = <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">add_worker</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:add_workers</span>])
            <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;ADDING #{options[:add_workers]} workers PIDS: #{pids.inspect}&quot;</span>
          <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:remove_workers</span>]
            <span class="ruby-identifier">pids</span> = <span class="ruby-identifier">manager</span>.<span class="ruby-identifier">remove_workers</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:remove_workers</span>])
            <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;REMOVING #{options[:remove_workers]} workers PIDS: #{pids.inspect}&quot;</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">DRb</span><span class="ruby-operator">::</span><span class="ruby-constant">DRbConnError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
          <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Couldnt add or remove workers. There are probably no workers running. At least I couldn't find a skynet_manager around at #{Skynet::CONFIG[:SKYNET_LOCAL_MANAGER_URL]} #{e.inspect}&quot;</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
          <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Couldnt add or remove workers #{e.inspect} #{e.backtrace.join(&quot;\n&quot;)}&quot;</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">exit</span>

      <span class="ruby-keyword kw">else</span>

        <span class="ruby-keyword kw">begin</span>
          <span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Making sure there's an available MessageQueue&quot;</span>
          <span class="ruby-identifier">ts</span> = <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">MessageQueue</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
          <span class="ruby-identifier">fatal</span> <span class="ruby-node">&quot;Couldn't get MessageQueue! #{e.message}&quot;</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;ERROR!  Couldn't get MessageQueue! #{e.message}&quot;</span>)
        <span class="ruby-keyword kw">end</span>

        <span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;CONTINUING TO START : There IS an available MessageQueue&quot;</span>, <span class="ruby-identifier">options</span>

        <span class="ruby-comment cmt"># create main pid file</span>
        <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:pid_file</span>], <span class="ruby-value str">'w'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">file</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">$$</span>)
        <span class="ruby-keyword kw">end</span>

        <span class="ruby-keyword kw">begin</span>                                                                                                                   
          <span class="ruby-identifier">printlog</span> <span class="ruby-value str">&quot;STARTING THE MANAGER!!!!!!!!!!!&quot;</span>
          <span class="ruby-ivar">@manager</span> = <span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">Manager</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>)
          <span class="ruby-constant">DRb</span>.<span class="ruby-identifier">start_service</span>(<span class="ruby-constant">Skynet</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-identifier">:SKYNET_LOCAL_MANAGER_URL</span>], <span class="ruby-ivar">@manager</span>)
          <span class="ruby-identifier">info</span> <span class="ruby-node">&quot;WORKER MANAGER URI: #{DRb.uri}&quot;</span>
          <span class="ruby-ivar">@manager</span>.<span class="ruby-identifier">start_workers</span>
          <span class="ruby-ivar">@manager</span>.<span class="ruby-identifier">run</span>
          <span class="ruby-constant">DRb</span>.<span class="ruby-identifier">thread</span>.<span class="ruby-identifier">join</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemExit</span>, <span class="ruby-constant">Interrupt</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
          <span class="ruby-identifier">fatal</span>(<span class="ruby-node">&quot;Error in Manager.  Manager Dying. #{e.inspect} #{e.backtrace}&quot;</span>)        
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>
    <span class="ruby-keyword kw">end</span></pre>
</body>
</html>